---
title: "Draft figures for zebrafish paper "
output:
  bookdown::html_document2:
  toc: true
number_sections: true
toc_depth: 3
toc_float: true
theme: paper
bibliography: references.bib
csl: american-chemical-society.csl
---
  
```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE)

library(reticulate)
reticulate::use_condaenv("r-reticulate")
#reticulate::py_install("rdkit")
source("utils.r")
library(rawrr)
library(purrr)
library(flextable)
library(tidyverse)

```


# 74 PFAS Compounds 

```{r pfas-cmpd-info, eval = FALSE}

opera <- readxl::read_excel(path = "data/project_meta_info/PFAS-75_DSSTox_properties_v3.xlsx", sheet = 1) %>%
  janitor::clean_names()

pfas_cats <- read_csv("data/project_meta_info/pfas_rough_cats.csv") %>%
  janitor::clean_names() %>%
  dplyr::rename(pfas_id = no) %>%
  dplyr::select(casrn, category, pfas_id, class) %>%
  mutate(category = str_to_lower(category))


pfas <- left_join(opera, pfas_cats) %>%
  relocate(pfas_id, .before = preferred_name) %>%
  arrange(pfas_id)

write_csv(pfas, "data/project_meta_info/74pfas_info.csv")


```


```{r rdkit-functions}
# based on tutorial here: https://riveradelgado.com/post/2021/06/30/chemistry-in-rstudio-with-rdkit-and-reticulate/

Chem <- reticulate::import("rdkit.Chem")
Draw <- reticulate::import("rdkit.Chem.Draw")
Plt <- reticulate::import("matplotlib.pyplot")
AllChem <- reticulate::import("rdkit.Chem.AllChem")
```

```{r pfas-smiles-data}

pfas <- read_csv("data/project_meta_info/74pfas_info.csv") %>%
  janitor::clean_names() %>%
  select(pfas_id, casrn, preferred_name, ms_ready_smiles, category)
```

```{r }
save_structure <- function(smiles, chemical, path) {
  Chem <- reticulate::import("rdkit.Chem")
  Draw <- reticulate::import("rdkit.Chem.Draw")
  Plt <- reticulate::import("matplotlib.pyplot")
  AllChem <- reticulate::import("rdkit.Chem.AllChem")

  mol <- Chem$MolFromSmiles(smiles)

  filepath <- fs::path(path, chemical, ext = "png")
  # Unlike the functions before this function just saves to file without calling
  # knitr::include_graphics()
  Draw$MolToFile(mol = mol, filename = filepath, clearBackground = TRUE)
}

# save_structure(smiles = "FC(F)(F)COC(OCC(F)(F)F)OCC(F)(F)F", chemical = "test1", path = "images/molecules")

## 

pfoa = "OC(=O)C(F)(F)C(F)(F)C(F)(F)C(F)(F)C(F)(F)C(F)(F)C(F)(F)F" # PFOA

Draw <- reticulate::import("rdkit.Chem.Draw")

m <- Chem$MolFromSmiles(pfoa)
substructure  = Chem$MolFromSmarts("[CX3](=O)[OX2H1]")


```

```{r}
fs::dir_create("images/molecules")

table_chemicals <- pfas %>%
  # Loop over the smiles and chemical names to save to file
  # Use possibly to catch any errors if there are any.
  mutate(
    savemol = purrr::walk2(
      ms_ready_smiles, pfas_id,
      purrr::possibly(~ save_structure(
        smiles = .x,
        chemical = .y,
        path = "images/molecules"
      ),
      otherwise = "oh-no!"
      )
    )
  ) %>%
  mutate(
    # Record the path where images are stored. Convert to character the path
    # to allow flextable to handle the paths.
    structure_path = as.character(fs::path("images/molecules", pfas_id, ext = "png")),
    # Leave one column empty for the eventual location of the image
    structure = "",
    preferred_name = stringr::str_wrap(preferred_name, width = 20, exdent = 3),
    analysis_notes = ""
  )
```

```{r}
table_chemicals_ft <-
  flextable::flextable(
    table_chemicals,
    col_keys = c("pfas_id", "casrn", "preferred_name", "category" ,"ms_ready_smiles", "structure")
  )
```

```{r}
table_chemicals_ft <- flextable::compose(table_chemicals_ft,
  j = "structure",
  value = as_paragraph(as_image(src = structure_path, width = 1.5, height = 1.5))
)


```

```{r}
table_chemicals_ft <- flextable::theme_vanilla(table_chemicals_ft) %>%
  flextable::autofit()
table_chemicals_ft
```

## Grid of 74 PFAS structures


```{r, eval = FALSE}

multiple_smiles <- as.vector(pfas$ms_ready_smiles)

multiple_smiles <- c("","","","","","","","","","", multiple_smiles)


display_grid <- function(multiple_smiles,
                         size = 300, 
                         nrow = length(multiple_smiles)/7
                         ){
  
# mapping with python functions
mol_list <- purrr::map(multiple_smiles, Chem$MolFromSmiles)

filepath_grid <- fs::path("plot_grid", ext = "png")

img <- Draw$MolsToGridImage(mol_list,
                            molsPerRow = as.integer(nrow),
                            # Set the size of each molecule in the grid
                            # as.integer() is a necessary part for python to interpret
                            # correctly the input
                            subImgSize = c(as.integer(size), as.integer(size))
                            )
  
    img$save(filepath_grid)
 knitr::include_graphics(filepath_grid)
 
}
display_grid(multiple_smiles)

```

# 74 PFAS Toxicity data 

- from Jiajun Han et al., EHP, 2021. 

```{r}
toxRaw <- read_csv("data/project_meta_info/jiajun_EHP2020.csv")

# compounds with high BCF
bcf <- toxRaw %>%
  filter(measure == 'bcf, 5 uM') %>%
  filter(mean >= 10) 

# compounds with high mortality
mortality <- toxRaw %>%
  filter(measure == "mortality") %>%
  filter(mean >=10) # 10% mortality requires full study. 

# union of important compounds 

targetCmpds <- unique(bcf$pfas, mortality$pfas) %>%
  append(., 60)

# Col headers for plots

headers <- data.frame("measure" = unique(toxRaw$measure),
                      "header" = c("Pericadial\nEdema (n)",
                                   "Tail\nDysplasia (n)",
                                   "Spinal\nCurvature (n)",
                                   "BCF, 0.5 µM\n(L/kg)",
                                   "BCF, 5 µM\n(L/kg)",
                                   "Mortality\n(%)"
                                   ))

tox <- toxRaw %>%
  #filter(measure != 'bcf, 0.5 uM') %>%
  mutate(annotCmpds = case_when(pfas %in% targetCmpds ~ pfas, 
                                TRUE ~ 0),
         annotAlpha = case_when(pfas %in% targetCmpds ~ 1, 
                                TRUE ~0.5)) %>%
  left_join(., y = headers)

# basic plot 
p <- ggplot(data = tox, 
       aes(x = pfas,
           y = mean,
           ymin = mean-sd, 
           ymax = mean+sd,
           colour = as.factor(annotCmpds),
           alpha = annotAlpha)) +
  geom_point(size = 1) + 
  geom_errorbar() +
  facet_wrap(vars(header), scales = "free_x", nrow = 1) 
 


# adjusting aesthetics 
p2 <- p +
  scale_colour_viridis_d()+
  coord_flip() +
  theme_bw() +
    theme(legend.position = "none",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(size = 6),
          axis.text.y = element_text(size = 6),
          strip.text.x = element_text(size = 6),
          axis.title.x = element_text(size = 8),
          axis.title.y = element_text(size = 8),
          panel.spacing = unit(.1, "cm"))  +
  scale_x_continuous(breaks = targetCmpds,
                     guide = guide_axis(n.dodge=2)) +
  scale_y_continuous(labels = scales::number_format(accuracy = 1),
                     guide = guide_axis(check.overlap = TRUE)) +
  expand_limits(x = 0, y = 0) +
  labs(x = "PFAS compound ID", 
       y = "mean ± SD")
p2
```
```{r}
ggsave(plot = p2, 
       file = "images/toxData.png", 
       units = "in", 
       width = 5, 
       height = 3)
```

# MS sample loading information 

```{r saving-ms-info, eval = FALSE}
## 
# list of scan headers to keep 
scanHeaderKeep <- c("RAW file", "Creation date", "Instrument method", "Sample vial")
# Location of archives ms files
zebPath <- "F:/zebrafish/"

# March info 
march_MSinfo <- ms_files_info(path = paste0(zebPath, "20220315") ,
                   fileExt = ".raw", 
                   scanHeaderKeep = scanHeaderKeep)

write_csv(march_MSinfo, file = "data/project_meta_info/ms-info-march-batch1.csv")


# may info 
may_MSinfo <- ms_files_info(path = paste0(zebPath, "20220502") ,
                   fileExt = ".raw", 
                   scanHeaderKeep = scanHeaderKeep)

write_csv(may_MSinfo, file = "data/project_meta_info/ms-info-may-batch1.csv")


# july info 
july_MSinfo <- ms_files_info(path = paste0(zebPath, "20220713") ,
                   fileExt = ".raw", 
                   scanHeaderKeep = scanHeaderKeep)

write_csv(july_MSinfo, file = "data/project_meta_info/ms-info-july-batch1.csv")


# august info batch one
august_MSinfo <- ms_files_info(path = paste0(zebPath, "20220815") ,
                   fileExt = ".raw", 
                   scanHeaderKeep = scanHeaderKeep)

write_csv(august_MSinfo, file = "data/project_meta_info/ms-info-august-batch1.csv")

# august info batch one
august_MSinfo <- ms_files_info(path = paste0(zebPath, "20220829") ,
                   fileExt = ".raw", 
                   scanHeaderKeep = scanHeaderKeep)

write_csv(august_MSinfo, file = "data/project_meta_info/ms-info-august-batch2.csv")
```

When files were transfered to SSD for analysis by DIA-NN, the following file names were changed: 

- `66__DIAPlexV1.raw` was changed to `65_3_DIAPlexV1.raw`
- `06_1_DIAPlexV1.raw` is a reinjection of sample `6_1`; both are fine. 
- `62_3_DIAplexV1_20220724025251.raw` was changed to `62_3_DIAplexV1.raw`
- `30_1_plexDIAv130_2_plexDIAv1.raw` changed to `30_1_plexDIAv1.raw`
- `28_1_plexDIAv1_20220823124824.raw` changed to `28_1_plexDIAv1.raw`, and should be used over original `28_1_plexDIAv1.raw` file
- `41_1_plexDIAv1_20220824123403.raw` is a reinjection of `41_1`, both are fine

Additionally the following samples were reinjected after column clean-up as part of the second August batch, the files from the second batch and were used for DIA-NN analysis. 

- `12_1:3`
- `34_1:3`
- `44_1:3`