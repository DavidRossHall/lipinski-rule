---
title: "Lipinski rule over environmental chemical space"
author: "David Ross Hall"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
  fig_caption: true
    number_sections: false
    number_sections: true
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)

library(webchem)
library(tidyverse)
source("utils.r")
```

### David Hall --- created on 2022-09-02

# Lipinski's rule of 5

*As outlined on [wikipedia](https://en.wikipedia.org/wiki/Lipinski%27s_rule_of_five)*

 - No more than 5 hydrogen bond donors (the total number of nitrogen–hydrogen and oxygen–hydrogen bonds)
 - No more than 10 hydrogen bond acceptors (all nitrogen or oxygen atoms)
 - A molecular mass less than 500 daltons
 -An octanol-water partition coefficient (log P) that does not exceed 5



# Importing datasets

- Ripped EPA's Toxic Substances Control Act (TSCA) Chemical Substance Inveoty from steven. 
- Ditto w/ the inventory of ToxCast compounds
- drugs from [here](https://www.cureffi.org/2013/10/04/list-of-fda-approved-drugs-and-cns-drugs-with-smiles/)

```{r import}

tsca_raw <- read_csv("data/TSCAINV_202202.csv") %>%
  janitor::clean_names()

toxcast <- read_csv("data/toxcast_inv.csv") %>%
  janitor::clean_names()

drugs_raw <- read_tsv("data/drugs.tsv") %>%
  janitor::clean_names()

```


# Data prep for plots

## Expanding TSCA database

- Removed *Unknown or Variable Compositions, Complex reaction products, and Biological materials)* (UVCBs) from TSCA. Defintions can be found [here](https://www.epa.gov/sites/default/files/2015-05/documents/uvcb.tsca <- tsca_raw %>%filter(is.na(uvcb))pdf)
- `flag` refers to compounds flagged in the TSCA. The meaning of EPA regulatory flags can be found [here](https://www.epa.gov/tsca-inventory/how-access-tsca-inventory#flags).
- `activity` refers to the commercial activity status.

```{r tsca-data, eval = FALSE}
# getting logp values and cas from TSCA
# running at 10:30, Sat AM
# removing UVCB compounds
tsca <- tsca_raw %>%
  filter(is.na(uvcb)) %>%
  mutate(casrn = str_replace_all(casrn, "/", "-"))

# small test dataset 
tsca_test <- sample_n(tsca, 500)

# getting pubchem CID for properties search
tsca_cid <- get_cid(tsca$casrn) %>%
  filter(!is.na(cid)) 

# querying pubchem for CID for lipinski search
tsca_props <- pc_prop(cid = tsca_cid$cid,
                      properties = c("XLogP", 
                                     "MolecularFormula", 
                                     "MolecularWeight",
                                     "HBondDonorCount",
                                     "HBondAcceptorCount"))


# querying pubchem for lipinksi properties
tsca_lipinski <- tsca_props %>%
  is_lipinski(df = .,
              h_donor = "HBondDonorCount",
              h_accept = "HBondAcceptorCount",
              mw = "MolecularWeight",
              logp = "XLogP")


# combining TSCA datasets together
tsca_all <- tsca_lipinski %>%
  mutate(CID = as.character(CID)) %>%
  left_join(., tsca_cid, by = c("CID" = "cid")) %>%
  rename(casrn = query) %>%
  left_join(., tsca, by = c("casrn" = "casrn")) %>%
  janitor::clean_names() %>%
  mutate(molecular_weight = as.numeric(molecular_weight))

# saving test dataset
write_csv(tsca_all, file = "data/TSCA_Data.csv")
  
```

## FDA approved human drugs


```{r drugs-dataset, eval = FALSE}

#drugs_test <- sample_n(drugs_raw, 50)


drugs_cid <- get_cid(drugs_raw$generic_name) %>%
  filter(!is.na(cid))

# querying pubchem for CID for lipinski search
drugs_props <- pc_prop(cid = drugs_cid$cid,
                      properties = c("XLogP", 
                                     "MolecularFormula", 
                                     "MolecularWeight",
                                     "HBondDonorCount",
                                     "HBondAcceptorCount"))


# querying pubchem for lipinksi properties
drugs_lipinski <- drugs_props %>%
  is_lipinski(df = .,
              h_donor = "HBondDonorCount",
              h_accept = "HBondAcceptorCount",
              mw = "MolecularWeight",
              logp = "XLogP")

# combining TSCA datasets together
drugs_all <- drugs_lipinski %>%
  mutate(CID = as.character(CID)) %>%
  left_join(., drugs_cid, by = c("CID" = "cid")) %>%
  left_join(., drugs_raw, by = c("query" = "generic_name")) %>%
  janitor::clean_names() %>%
  mutate(molecular_weight = as.numeric(molecular_weight))

write_csv(x = drugs_all, file = "data/drugs_all.csv")

```


## Pops 


```{r pops-data, eval = FALSE}

pops_raw <- read_tsv("data/pops.csv") %>%
  janitor::clean_names()

pops_cid <- get_cid(pops_raw$cas_number) %>%
  filter(!is.na(cid))

# querying pubchem for CID for lipinski search
pops_props <- pc_prop(cid = pops_cid$cid,
                      properties = c("XLogP", 
                                     "MolecularFormula", 
                                     "MolecularWeight",
                                     "HBondDonorCount",
                                     "HBondAcceptorCount"))


# querying pubchem for lipinksi properties
pops_lipinski <- pops_props %>%
  is_lipinski(df = .,
              h_donor = "HBondDonorCount",
              h_accept = "HBondAcceptorCount",
              mw = "MolecularWeight",
              logp = "XLogP")

# combining TSCA datasets together
pops_all <- pops_lipinski %>%
  mutate(CID = as.character(CID)) %>%
  left_join(., pops_cid, by = c("CID" = "cid")) %>%
  left_join(., pops_raw, by = c("query" = "cas_number")) %>%
  janitor::clean_names() %>%
  mutate(molecular_weight = as.numeric(molecular_weight)) %>%
  rowid_to_column() %>%
  group_by(query) %>%
  slice_min(order_by = rowid) %>%
  select(-rowid)
  

write_csv(x = pops_all, file = "data/pops_all.csv")

```

# Plotting TSCA chemical space 

```{r dataforplot}
tsca <- read_csv('data/TSCA_Data.csv') %>%
  filter(cid != "111615") %>%
  rowid_to_column() %>%
  group_by(id) %>%
  slice_min(order_by = rowid) %>%
  select(-rowid)

pops <- read_csv("data/pops_all.csv") %>%
  filter(str_length(chemical)<10)

```

```{r}
p <- ggplot(data = subset(tsca, molecular_weight < 1500 & abs(x_log_p) <= 30), 
       aes(x = molecular_weight,
           y = x_log_p)) 

p +
  stat_bin2d(bins = 50) +
  #scale_fill_gradient(low = "lightblue", high = "red", trans="log2") +
  jcolors::scale_fill_jcolors_contin("pal12", bias = 1.5) +
  theme_classic() +
    geom_rect(aes(xmin = 0, xmax = 500, ymin = 0, ymax = 5), 
            alpha = 0, color = "grey80") +
  geom_point(data = pops, 
             aes(x = molecular_weight, 
                 y = x_log_p, 
                 label = chemical), colour = "white") +
  ggrepel::geom_label_repel(data = subset(pops, x_log_p <= 4), 
                            aes(x = molecular_weight, 
                                y = x_log_p, 
                                label = chemical),
                            box.padding = 0.5, 
                            max.overlaps = Inf,
                            force = 100,
                            nudge_y = -20,
                            segment.curvature = -1e-20) +
    ggrepel::geom_label_repel(data = subset(pops, x_log_p >= 4), 
                            aes(x = molecular_weight, 
                                y = x_log_p, 
                                label = chemical),
                            box.padding = 0.5, 
                            max.overlaps = Inf,
                            force = 100,
                            nudge_y = 30,
                            segment.curvature = -1e-20)




```

```{r}
drugs <- read_csv("data/drugs_all.csv")

p <- ggplot(data = subset(drugs, molecular_weight < 1500 & abs(x_log_p) <= 30), 
       aes(x = molecular_weight,
           y = x_log_p)) 

p +
  stat_bin2d(bins = 50) +
  scale_fill_gradient(low = "lightblue", high = "red") +
  theme_classic() +
    geom_rect(aes(xmin = 0, xmax = 500, ymin = 0, ymax = 5), 
            alpha = 0, color = "black")
```

