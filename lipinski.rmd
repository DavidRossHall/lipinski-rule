---
title: "Lipinski rule over environmental chemical space"
author: "David Ross Hall"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
  fig_caption: true
    number_sections: false
    number_sections: true
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)

library(webchem)
library(tidyverse)
source("utils.r")
```

### David Hall --- created on 2022-09-02

# Lipinski's rule of 5

*As outlined on [wikipedia](https://en.wikipedia.org/wiki/Lipinski%27s_rule_of_five)*

 - No more than 5 hydrogen bond donors (the total number of nitrogen–hydrogen and oxygen–hydrogen bonds)
 - No more than 10 hydrogen bond acceptors (all nitrogen or oxygen atoms)
 - A molecular mass less than 500 daltons
 -An octanol-water partition coefficient (log P) that does not exceed 5



# Importing datasets

- Ripped EPA's Toxic Substances Control Act (TSCA) Chemical Substance Inveoty from steven. 
- Ditto w/ the inventory of ToxCast compounds
- drugs from [here](https://www.cureffi.org/2013/10/04/list-of-fda-approved-drugs-and-cns-drugs-with-smiles/)

```{r import}

tsca_raw <- read_csv("data/TSCAINV_202202.csv") %>%
  janitor::clean_names()

toxcast <- read_csv("data/toxcast_inv.csv") %>%
  janitor::clean_names()

drugs_raw <- read_tsv("data/drugs.tsv") %>%
  janitor::clean_names()

```

# Expanding TSCA database


- Removed *Unknown or Variable Compositions, Complex reaction products, and Biological materials)* (UVCBs) from TSCA. Defintions can be found [here](https://www.epa.gov/sites/default/files/2015-05/documents/uvcb.tsca <- tsca_raw %>%filter(is.na(uvcb))pdf)
- `flag` refers to compounds flagged in the TSCA. The meaning of EPA regulatory flags can be found [here](https://www.epa.gov/tsca-inventory/how-access-tsca-inventory#flags).
- `activity` refers to the commercial activity status.



```{r tsca-data}
# getting logp values and cas from TSCA

# removing UVCB compounds
tsca <- tsca_raw %>%
  filter(is.na(uvcb))

# small test dataset 
tsca_test <- sample_n(tsca, 500)

# getting pubchem CID for properties search
tsca_cid <- get_cid(tsca_test$casrn) %>%
  filter(!is.na(cid)) 

# querying pubchem for CID for lipinski search
tsca_props <- pc_prop(cid = tsca_cid$cid,
                      properties = c("XLogP", 
                                     "MolecularFormula", 
                                     "MolecularWeight",
                                     "HBondDonorCount",
                                     "HBondAcceptorCount"))


# querying pubchem for lipinksi properties
tsca_lipinski <- tsca_props %>%
  is_lipinski(df = .,
              h_donor = "HBondDonorCount",
              h_accept = "HBondAcceptorCount",
              mw = "MolecularWeight",
              logp = "XLogP")


# combining TSCA datasets together
tsca_all <- tsca_lipinski %>%
  mutate(CID = as.character(CID)) %>%
  left_join(., tsca_cid, by = c("CID" = "cid")) %>%
  rename(casrn = query) %>%
  left_join(., tsca_test, by = c("casrn" = "casrn")) %>%
  janitor::clean_names() %>%
  mutate(molecular_weight = as.numeric(molecular_weight))

# saving test dataset
#write_csv(tsca_all, file = "data/TSCA_testData.csv")
  
```

```{r drugs-dataset}

#drugs_test <- sample_n(drugs_raw, 50)


drugs_cid <- get_cid(drugs_raw$generic_name) %>%
  filter(!is.na(cid))

# querying pubchem for CID for lipinski search
drugs_props <- pc_prop(cid = drugs_cid$cid,
                      properties = c("XLogP", 
                                     "MolecularFormula", 
                                     "MolecularWeight",
                                     "HBondDonorCount",
                                     "HBondAcceptorCount"))


# querying pubchem for lipinksi properties
drugs_lipinski <- drugs_props %>%
  is_lipinski(df = .,
              h_donor = "HBondDonorCount",
              h_accept = "HBondAcceptorCount",
              mw = "MolecularWeight",
              logp = "XLogP")

# combining TSCA datasets together
drugs_all <- drugs_lipinski %>%
  mutate(CID = as.character(CID)) %>%
  left_join(., drugs_cid, by = c("CID" = "cid")) %>%
  left_join(., drugs_raw, by = c("query" = "generic_name")) %>%
  janitor::clean_names() %>%
  mutate(molecular_weight = as.numeric(molecular_weight))

write_csv(x = drugs_all, file = "data/drugs_all.csv")

```


```{r}

p <- ggplot(data = tsca_all, 
       aes(x = molecular_weight,
           y = x_log_p,
           colour = lipinski)) +
  geom_point(alpha = 0.3) 

p1 <- ggExtra::ggMarginal(p, 
                          type = "density"
                          )
p1

q <- ggplot(data = drugs_all, 
       aes(x = molecular_weight,
           y = x_log_p,
           colour = lipinski)) +
  geom_point(alpha = 0.3) 

q1 <- ggExtra::ggMarginal(q, 
                          type = "density"
                          )
q1
```

